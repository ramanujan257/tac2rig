%{
#include <iostream>
#include <string>
#include <vector>

#include "basic_blocks.hpp"

void yyeror(std::string s){
    std::cerr << s << std::endl;
}

extern int yylex();

std::vector<BasicBlock*> basicBlocks;
BasicBlock* currBB = nullptr;

BasicBlock* getCurrentBB(){
    return currBB;
}

void setCurrentBB(BasicBlock* bb){
    currBB = bb;
}

BasicBlock* bbLookup(int address){
    for(auto b : basicBlocks){
        for(auto l : b->getLines()){
            if(std::stoi(l) == address)
                return b;
        }
    }
    
    return nullptr;
}

%}

%union {
    int num;
    std::string str;
    BasicBlock* b;
}

%token<num> num_token
%token<str> id_token
%token goto_token if_token
%type<str> Linija E

%left '<' '='
%left '+' '-'
%left '*'

%%

Program: Program ';' Linija{
            getCurrentBB()->addLine($3);
        }
        |Linija {
            getCurrentBB()->addLine($1);
        }
        ;

Linija: num_token ':' id_token ':' '=' E {
            $$ = std::to_string($1) + ":" + $3 + ":=" + $6;
            }
       | num_token ':' id_token '[' id_token ']' ':' '=' E {
            $$ = std::to_string($1) + ":" + $3 + "[" + $5 + "]" + $9;
       }
       | num_token ':' if_token E goto_token '(' num_token ')' {
        
            BasicBlock* curr = getCurrentBB();
            BasicBlock* elseBB = new BasicBlock();
            basicBlocks.push_back(elseBB);
            curr->addChild(elseBB);
            BasicBlock* thenBB = bbLookup($7);
            if(!thenBB){
                thenBB = new BasicBlock();
                basicBlocks.push_back(thenBB);
            }
            curr->addChild(thenBB);
       
//            curr->addLine(std::to_string($1) + "if " + $2 + "goto B" + thenBB.getID())
            $$ = std::to_string($1) + ": if " + $4 + " goto B" + std::to_string(thenBB->getID()); 

            setCurrentBB(elseBB);
       }
       ;

E: E '+' E {
        $$ = $1 + "+" + $3;
    }
    | E '-' E {
        $$ = $1 + "-" + $3;
    }
    | E '*' E {
        $$ = $1 + "*" + $3;
    }
    | E '<' '=' E {
        $$ = $1 + "<=" $4;
    }
    | id_token {
        $$ = $1;
    }
    | num_token {
        $$ = std::to_string($1);
    }
    ;

%%

int main(){

    yyparse();
    return 0;
}
